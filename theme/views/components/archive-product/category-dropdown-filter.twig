{#
    Category Dropdown Filter Component

    Parameters:
    - title: Filter section title (e.g. "Categories")
    - items: Array of category items with structure:
      {
        id: unique identifier
        name: display name
        slug: url slug
        count: product count (optional)
        children: array of child items (for subcategories)
      }
    - is_link_category: (optional) When true, clicking categories navigates to their URL.
                        When false, uses AJAX filtering. Defaults to true.
    - all_expanded_default: (optional) When true, all parent categories start expanded. Defaults to true.
#}

{% set is_link_category = is_link_category is defined ? is_link_category : true %}
{% set all_expanded_default = all_expanded_default is defined ? all_expanded_default : true %}
{% set current_category_id = current_category_id is defined ? current_category_id : null %}

<div class="filter-section mb-4" x-data="categoryDropdownFilter({{ items|json_encode|e('html_attr') }}, {{ is_link_category ? 'true' : 'false' }}, {{ all_expanded_default ? 'true' : 'false' }})">
    
    <!-- Filter Header -->
    <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold text-gray-900 mt-0 mb-0">{{ title }}</h3>
        {% if not is_link_category %}
        <div class="flex items-center space-x-2 text-xs">
            <button @click="toggleExpandAll()"
                    class="text-[#7D8184]"
                    x-text="allExpanded ? 'Collapse All' : 'Expand All'">
            </button>
            <span class="text-gray-400">|</span>
            <button @click="if(clearAll()) $dispatch('filter-changed')"
                    class="text-[#7D8184]">
                Clear
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Category Items -->
    <div class="space-y-1">
        <template x-for="(item, index) in items" :key="item.id">
            <div class="category-item">
                <!-- Parent Category -->
                <div class="flex items-center justify-between">
                    <button @click="toggleCategory(item.id)"
                            class="flex items-center justify-between w-full py-2 text-left group">
                        <div class="flex items-center flex-1">
                            <span class="text-sm transition-colors"
                                  :class="{
                                      'text-gray-700': item.id != {{ current_category_id }} && !item.children?.some(child => child.id == {{ current_category_id }}),
                                      'text-gray-900 font-medium underline': item.id == {{ current_category_id }} || item.children?.some(child => child.id == {{ current_category_id }}),
                                      'border-b border-gray-900 font-medium': selectedCategories.includes(item.id) && item.id != {{ current_category_id }} && !item.children?.some(child => child.id == {{ current_category_id }}),
                                      'hover:text-gray-900': !selectedCategories.includes(item.id) && item.id != {{ current_category_id }} && !item.children?.some(child => child.id == {{ current_category_id }})
                                  }"
                                  x-text="item.name">
                            </span>
                            <span class="text-xs text-gray-400 ml-2" x-text="'(' + item.count + ')'" x-show="item.count"></span>
                        </div>
                    </button>
                </div>

                <!-- Subcategories -->
                <div x-show="item.children && item.children.length > 0 && expandedCategories.includes(item.id)" 
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 max-h-0"
                     x-transition:enter-end="opacity-100 max-h-96"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100 max-h-96"
                     x-transition:leave-end="opacity-0 max-h-0"
                     class="ml-4 mt-1 space-y-1 overflow-hidden">
                    <template x-for="child in item.children" :key="child.id">
                        <button @click="toggleCategory(child.id)"
                                class="flex items-center w-full py-1 text-left group">
                            <span class="text-sm text-gray-600 transition-colors"
                                  :class="{
                                      'border-b border-gray-900 font-medium text-gray-900': selectedCategories.includes(child.id),
                                      'hover:text-gray-900': !selectedCategories.includes(child.id),
                                      'font-medium underline': child.id == {{ current_category_id }}
                                  }"
                                  x-text="child.name">
                            </span>
                            <span class="text-xs text-gray-400 ml-2" x-text="'(' + child.count + ')'" x-show="child.count"></span>
                        </button>
                    </template>
                </div>
            </div>
        </template>
    </div>

    <!-- No items message -->
    <div x-show="items.length === 0" class="text-sm text-gray-500 py-4">
        No categories available
    </div>
</div>