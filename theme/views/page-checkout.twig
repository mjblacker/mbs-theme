{% extends "base.twig" %}

{% block content %}
    {# Check for WooCommerce endpoints #}
    {% set is_order_received = function('is_wc_endpoint_url', 'order-received') %}
    {% set is_order_pay = function('is_wc_endpoint_url', 'order-pay') %}

    {% if is_order_received %}
        {# Include the thankyou template for order-received pages #}
        {% include 'woocommerce/checkout/thankyou.twig' %}
    {% elseif is_order_pay %}
        {# Use custom styled order-pay template #}
        <div class="woocommerce container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            {{ function('wc_print_notices')|raw }}

            {% do function('do_action', 'before_woocommerce_pay') %}

            {% set order_id = function('absint', function('get_query_var', 'order-pay')) %}
            {% set order_key_param = function('filter_input', constant('INPUT_GET'), 'key', constant('FILTER_SANITIZE_FULL_SPECIAL_CHARS')) %}

            {# Check if this is a pay_for_order request - key is required #}
            {% if order_key_param and order_id %}
                {% set order_key = function('wc_clean', function('wp_unslash', order_key_param)) %}
                {% set order = function('wc_get_order', order_id) %}

                {# Validate order #}
                {% if not order %}
                    <div class="woocommerce-error bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded mb-4">
                        Invalid order.
                    </div>
                {% elseif not order.key_is_valid(order_key) %}
                    <div class="woocommerce-error bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded mb-4">
                        Invalid order.
                    </div>
                {% elseif order.get_status() == 'cancelled' %}
                    <div class="woocommerce-error bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded mb-4">
                        This order has been cancelled. Please contact us if you need assistance.
                    </div>
                {% elseif not order.needs_payment() %}
                    <div class="woocommerce-notice woocommerce-notice--success bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded mb-4">
                        This order's payment has already been processed.
                    </div>
                {% else %}
                    {# Valid order that needs payment #}
                    {% do function('wc_enqueue_js', "
                        jQuery(function($) {
                            $('input[name=\"payment_method\"]:checked').eq(0).trigger('click');
                        });
                    ") %}

                    {% set available_gateways = function('WC').payment_gateways.get_available_payment_gateways() %}
                    {% set order_button_text = function('apply_filters', 'woocommerce_pay_order_button_text', 'Pay for order') %}

                    {% include 'woocommerce/checkout/form-pay.twig' with {
                        order: order,
                        available_gateways: available_gateways,
                        order_button_text: order_button_text
                    } %}
                {% endif %}
            {% else %}
                <div class="woocommerce-error bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded mb-4">
                    Invalid order.
                </div>
            {% endif %}

            {% do function('do_action', 'after_woocommerce_pay') %}
        </div>
    {% else %}
        <div class="woocommerce-checkout mb-10">
            <!-- Breadcrumbs -->
            {% include 'woocommerce/breadcrumbs.twig' %}

            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 overflow-x-hidden">
                <!-- Check if WooCommerce checkout is available -->
                {% if function('WC') and function('WC').cart %}
                {% set wc_cart = function('WC').cart %}
                {% set wc_checkout = function('WC').checkout %}
                
                {# Calculate cart totals and shipping if needed #}
                {% do function('WC').cart.calculate_totals() %}
                {# Calculate shipping packages #}
                {% do function('WC').shipping.calculate_shipping(function('WC').cart.get_shipping_packages()) %}
                
                {{ function('do_action', 'woocommerce_before_checkout_form_table')|raw }}
                
                <!-- Main Checkout Layout -->
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 lg:gap-8" x-data="checkoutPage">
                    {{ function('do_action', 'woocommerce_before_checkout_form')|raw }}

                    <form name="checkout" method="post" class="checkout woocommerce-checkout col-span-full" action="{{ function('wc_get_checkout_url') }}" enctype="multipart/form-data" novalidate="novalidate">

                        {# Essential WooCommerce checkout fields #}
                        {{ function('wp_nonce_field', 'woocommerce-process_checkout', 'woocommerce-process-checkout-nonce', true, false)|raw }}

                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 lg:gap-8">
                            <!-- Checkout Content (Left Side) -->
                            <div class="lg:col-span-7">
                                {% include 'components/checkout/checkout-fields.twig' with {
                                    wc_checkout: wc_checkout,
                                    wc_cart: wc_cart
                                } %}
                            </div>

                            <!-- Order Summary (Right Side) -->
                            <div class="lg:col-span-5 woocommerce-checkout-review-order">
                                {% include 'components/checkout/order-summary.twig' with {
                                    wc_cart: wc_cart,
                                    wc_checkout: wc_checkout
                                } %}
                            </div>
                        </div>
                    </form>

                    {{ function('do_action', 'woocommerce_after_checkout_form')|raw }}
                </div>

                {{ function('do_action', 'woocommerce_after_checkout_form_table')|raw }}
                
                {% else %}
                    <div class="text-center py-12">
                        <p class="text-gray-600 text-lg">WooCommerce is not available.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
{% endblock %}