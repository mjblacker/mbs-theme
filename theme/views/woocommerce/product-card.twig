{# 
  Product Card Component
  
  Parameters:
  - post: WP_Post object for the product
  - product: WC_Product object (optional, will be fetched if not provided)  
  - show_brand: boolean - whether to show brand/category (default: true)
  - show_sale_badge: boolean - whether to show sale badge (default: true)
#}

{% set product = product ?: function('wc_get_product', post.ID) %}
{% set show_brand = show_brand is defined ? show_brand : true %}
{% set show_sale_badge = show_sale_badge is defined ? show_sale_badge : true %}

{% if product %}
    <div class="product-item bg-white relative group h-full flex flex-col transition-transform duration-200 ease-in-out hover:-translate-y-1">
        <!-- Sale Badge -->
        {% if show_sale_badge and product.is_on_sale() %}
            {% set regular_price = product.get_regular_price() %}
            {% set sale_price = product.get_sale_price() %}
            {% if regular_price and sale_price %}
                {% set discount_percent = (((regular_price - sale_price) / regular_price) * 100)|round %}
                <div class="absolute top-3 left-3 bg-green-500 text-white px-2 py-1 rounded z-10 text-xs font-semibold">
                    -{{ discount_percent }}%
                </div>
            {% endif %}
        {% endif %}

        <a href="{{ post.link ?: function('get_permalink', post.ID) }}" class="flex-1 flex flex-col">
            <!-- Product Image -->
            {% if post.thumbnail %}
                <div class="aspect-square overflow-hidden rounded-md bg-gray-100 mb-4">
                    <img src="{{ post.thumbnail.src('medium') }}" 
                         alt="{{ post.thumbnail.alt }}"
                         class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300 ease-out mt-0 mb-0">
                </div>
            {% else %}
                {% set thumbnail = function('get_the_post_thumbnail_url', post.ID, 'medium') %}
                {% if thumbnail %}
                    <div class="aspect-square rounded-md overflow-hidden bg-gray-100 mb-4">
                        <img src="{{ thumbnail }}" 
                             alt="{{ post.post_title ?: post.title }}"
                             class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300 ease-out mt-0 mb-0">
                    </div>
                {% else %}
                    <div class="aspect-square rounded-md bg-gray-100 mb-4 flex items-center justify-center">
                        <span class="text-gray-400 text-sm">No Image</span>
                    </div>
                {% endif %}
            {% endif %}
            
            <!-- Product Info -->
            <div class="flex flex-col flex-1">
                <!-- Brand Name -->
                {% if show_brand %}
                    {% set product_brands = function('get_the_terms', post.ID, 'product_brand') %}
                    {% if product_brands and product_brands is not same as(false) %}
                        <div class="text-gray-500 uppercase tracking-wide mb-1 text-xs font-normal leading-tight">
                            {{ product_brands[0].name }}
                        </div>
                    {% else %}
                        <div class="text-gray-500 uppercase tracking-wide mb-1 text-xs font-normal leading-tight">
                            BRAND NAME
                        </div>
                    {% endif %}
                {% endif %}
                
                <!-- Product Name -->
                <h3 class="text-gray-900 leading-tight mb-2 flex-1 text-product-title font-semibold mt-2.5 line-clamp-2">{{ post.title ?: post.post_title }}</h3>
                
                <!-- Price -->
                <div class="flex items-center flex-wrap mb-2">
                    {% if product.is_type('variable') %}
                        <!-- Variable product - show price range -->
                        {% set price_html = product.get_price_html() %}
                        {% if price_html %}
                            <span class="text-gray-900 text-product-title font-normal leading-tight">
                                {{ price_html|raw }}
                            </span>
                        {% endif %}
                    {% elseif product.is_on_sale() and product.get_sale_price() %}
                        <!-- Simple product on sale -->
                        <span class="text-gray-900 text-product-title font-normal leading-tight">
                            {{ function('wc_price', product.get_sale_price())|raw }}
                        </span>
                        {% if product.get_regular_price() %}
                            <span class="text-gray-500 line-through ml-2 text-base font-normal">
                                {{ function('wc_price', product.get_regular_price())|raw }}
                            </span>
                        {% endif %}
                    {% else %}
                        <!-- Regular product price -->
                        <span class="text-gray-900 text-product-title font-normal leading-tight">
                            {{ function('wc_price', product.get_price())|raw }}
                        </span>
                    {% endif %}
                    <span class="text-gray-500 ml-1 text-base font-normal">INC GST</span>
                </div>
            </div>
        </a>
        
        <!-- Add to Cart Button -->
        {% if product.is_type('simple') %}
            <div x-data="productCardCart()" class="flex items-center gap-3 mt-2">
                <button @click="addToCart('{{ product.get_id() }}')" 
                        :class="addToCartButtonClasses"
                        :disabled="loading"
                        class="bg-[#FFF200] text-black transition-colors py-2 px-4 text-xs font-semibold uppercase border-0 rounded-none flex-shrink-0 cursor-pointer">
                    <span x-show="!loading">Add To Cart</span>
                    <span x-show="loading" class="inline-flex items-center">
                        <svg class="animate-spin -ml-1 mr-2 h-3 w-3 text-black" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Adding...
                    </span>
                </button>
                
                <!-- Success Message -->
                <div x-show="showSuccess" 
                     @click="goToCart()"
                     x-text="successMessage"
                     :class="{ 'cursor-pointer hover:underline': isViewCartLink, 'cursor-default': !isViewCartLink }"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100 scale-100"
                     x-transition:leave-end="opacity-0 scale-95"
                     class="text-green-600 text-xs font-medium flex items-center"
                     style="display: none;">
                </div>
            </div>
        {% else %}
        <div class="flex items-center gap-3 mt-2">
            <a href="{{ post.link ?: function('get_permalink', post.ID) }}" 
               class="bg-[#FFF200] !text-black transition-colors py-2 px-4 mt-2 inline-block text-xs font-semibold uppercase no-underline border-0 rounded-none">
                View Options
            </a>
        </div>
        {% endif %}
    </div>
{% endif %}