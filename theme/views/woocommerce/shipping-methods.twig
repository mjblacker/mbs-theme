{# Unified Shipping Methods Component
   Props: 
   - context: 'cart' or 'checkout' (determines styling and layout)
   - wc_cart: WooCommerce cart object
   - wc_checkout: WooCommerce checkout object (optional, only for checkout context)
   - show_calculator: boolean to show shipping calculator (default: true for cart, false for checkout)
#}

{% set context = context ?: 'cart' %}
{% set show_calculator = show_calculator is defined ? show_calculator : (context == 'cart') %}

{% if wc_cart.needs_shipping() and wc_cart.show_shipping() %}
    {{ function('do_action', context == 'cart' ? 'woocommerce_cart_totals_before_shipping' : 'woocommerce_review_order_before_shipping')|raw }}
    
    <div class="shipping-methods-container">
        {% if context == 'checkout' %}
            <h4 class="font-medium text-gray-900 mb-3 mt-5">Shipping</h4>
        {% else %}
            <h3 class="text-lg font-medium text-gray-900 mb-4">Select Shipping</h3>
        {% endif %}
        
        {# Get shipping packages and render each one #}
        {% set shipping_packages = wc_cart.get_shipping_packages() %}
        {% for package_key, package in shipping_packages %}
            {# Get chosen shipping method for this package #}
            {% set chosen_method = function('WC').session.get('chosen_shipping_methods')[package_key] ?? '' %}
            
            {# Calculate shipping for this package if not already done #}
            {% do function('WC').shipping.calculate_shipping([package]) %}
            {% set rates = function('WC').shipping.get_packages()[package_key]['rates'] ?? [] %}
            
            {% if rates %}
                <div class="shipping-methods {{ context == 'cart' ? 'space-y-3' : 'space-y-2' }} mb-4">
                    {% for method in rates %}
                        {% set method_id = function('sanitize_title', method.id) %}
                        {% set input_id = 'shipping_method_' ~ package_key ~ '_' ~ method_id %}
                        {% set is_checked = (method.id == chosen_method) %}
                        {% set method_title = method.label %}
                        {% set method_cost = method.cost > 0 ? function('wc_price', method.cost) : 'FREE' %}
                        
                        {# Split method title by colon to separate method name and location #}
                        {% set title_parts = method_title|split(' : ') %}
                        {% set method_name = title_parts[0]|trim %}
                        {% set location_info = title_parts[1] is defined ? title_parts[1]|trim : '' %}
                        
                        <div class="shipping-method-option">
                            <input type="{{ rates|length > 1 ? 'radio' : 'hidden' }}" 
                                   name="shipping_method[{{ package_key }}]" 
                                   data-index="{{ package_key }}" 
                                   id="{{ input_id }}" 
                                   value="{{ method.id }}" 
                                   class="shipping_method sr-only" 
                                   {{ is_checked ? 'checked' : '' }} />
                            
                            {# Use cart's 3-column design for both cart and checkout #}
                            <label for="{{ input_id }}" class="shipping-method-label grid grid-cols-12 !items-start p-2 rounded-lg cursor-pointer">
                                <div class="col-span-1 flex justify-center">
                                    <div class="radio-button flex-shrink-0 w-5 h-5 border-2 border-gray-300 rounded-full relative mt-[3px]">
                                        <div class="radio-inner absolute inset-0.5 bg-black rounded-full scale-0 transition-transform"></div>
                                    </div>
                                </div>
                                
                                <div class="col-span-4">
                                    <div class="method-name font-medium text-gray-900">{{ method_name }}</div>
                                </div>
                                
                                <div class="col-span-5">
                                    {% if location_info %}
                                        <div class="method-location text-sm text-gray-600">
                                            {{ location_info }}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-span-2 text-right">
                                    <div class="method-price font-semibold text-gray-900">
                                        {{ method_cost|raw }}
                                    </div>
                                </div>
                            </label>
                        </div>
                        {{ function('do_action', context == 'cart' ? 'woocommerce_after_shipping_rate' : 'woocommerce_after_shipping_rate', method, package_key)|raw }}
                    {% endfor %}
                </div>
                
                {# Shipping destination text (cart only) #}
                {% if context == 'cart' and function('is_cart') and function('get_theme_mod', 'cart_estimate_text', 1) %}
                    {% set formatted_destination = function('WC').countries.get_formatted_address(package.destination, ', ') %}
                    {% if formatted_destination %}
                        <p class="woocommerce-shipping-destination text-sm text-gray-600 mt-4">
                            {{ function('sprintf', function('__', 'Shipping to %s.', 'woocommerce'), '<strong>' ~ formatted_destination ~ '</strong>')|raw }}
                            {% set calculator_text = function('__', 'Delivery', 'woocommerce') %}
                        </p>
                    {% else %}
                        <p class="text-sm text-gray-600 mt-4">
                            {{ function('apply_filters', 'woocommerce_shipping_estimate_html', function('__', 'Shipping options will be updated during checkout.', 'woocommerce'))|raw }}
                        </p>
                    {% endif %}
                {% endif %}
            {% endif %}
        {% endfor %}
    </div>
    
    {{ function('do_action', context == 'cart' ? 'woocommerce_cart_totals_after_shipping' : 'woocommerce_review_order_after_shipping')|raw }}

{% elseif function('get_option', 'woocommerce_enable_shipping_calc') == 'yes' %}
    {# No shipping methods available but calculator enabled #}
    {% if context == 'cart' %}
        <div class="shipping-section mb-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Select Shipping</h3>
            {% if wc_cart.needs_shipping() %}
                <div class="shipping-placeholder p-4 border border-gray-200 rounded-lg bg-gray-50">
                    <p class="text-gray-600 mb-3">Calculate shipping rates for your location</p>
                    {% if show_calculator %}
                        {{ function('woocommerce_shipping_calculator', calculator_text ?? '')|raw }}
                    {% endif %}
                </div>
            {% else %}
                <div class="shipping-placeholder p-4 border border-gray-200 rounded-lg bg-gray-50">
                    <span class="text-gray-500">Add products to calculate shipping</span>
                </div>
            {% endif %}
        </div>
    {% else %}
        <div class="shipping-section mb-4">
            <div class="total-row flex justify-between items-center py-3 border-b border-gray-200">
                <span class="text-gray-600">Shipping</span>
                <span class="text-sm text-gray-500">Enter your address to view shipping options</span>
            </div>
        </div>
    {% endif %}
{% endif %}

{# Shipping Calculator (only for cart context) #}
{% if context == 'cart' and show_calculator %}
    {% if function('get_option', 'woocommerce_enable_shipping_calc') == 'yes' %}
        {{ function('woocommerce_shipping_calculator', calculator_text ?? '')|raw }}
    {% endif %}
{% endif %}