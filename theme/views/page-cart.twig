{% extends "base.twig" %}

{% block content %}
    <div class="woocommerce-cart mb-10">
        <!-- Breadcrumbs -->
        {% include 'woocommerce/breadcrumbs.twig' %}

        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Check if WooCommerce cart is available -->
            {% if function('WC') and function('WC').cart %}
                {% set wc_cart = function('WC').cart %}
                
                <!-- Main Cart Layout -->
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <!-- Cart Content - Custom Implementation -->
                    <div class="lg:col-span-7" x-data="cartPage">
                        <div class="cart-content">
                            <!-- Cart Table Header -->
                            <div class="hidden md:grid md:grid-cols-12 gap-4 pb-4 mb-6 border-b border-gray-200 text-sm font-medium text-gray-700">
                                <div class="md:col-span-1"></div>
                                <div class="md:col-span-5">Product</div>
                                <div class="md:col-span-2 text-center">Qty</div>
                                <div class="md:col-span-4 text-right">Subtotal</div>
                            </div>

                            <!-- Cart Items -->
                            {% if not wc_cart.is_empty() %}
                                {% set cart_items = wc_cart.get_cart() %}
                                
                                <!-- WooCommerce before cart hook -->
                                {{ function('do_action', 'woocommerce_before_cart')|raw }}
                                
                                <!-- WooCommerce Cart Form -->
                                <form class="woocommerce-cart-form" action="{{ function('wc_get_cart_url') }}" method="post">
                                {{ function('do_action', 'woocommerce_before_cart_table')|raw }}
                                
                                {% for cart_item_key, cart_item in cart_items %}
                                    {% set product = cart_item.data %}
                                    {% set product_post = function('get_post', product.get_id()) %}
                                    
                                    {# For variations, get parent product for image and brand #}
                                    {% if product.is_type('variation') %}
                                        {% set parent_id = product.get_parent_id() %}
                                        {% set image_id = parent_id %}
                                        {% set brand_id = parent_id %}
                                    {% else %}
                                        {% set image_id = product.get_id() %}
                                        {% set brand_id = product.get_id() %}
                                    {% endif %}
                                    
                                    <div class="cart-item grid grid-cols-1 md:grid-cols-12 gap-4 py-6 border-b border-gray-100 last:border-b-0">
                                        <!-- Remove Button -->
                                        <div class="md:col-span-1 flex items-center justify-center">
                                            <a href="{{ function('wc_get_cart_remove_url', cart_item_key) }}"
                                               class="cart-remove-item text-gray-400 hover:text-red-500 focus:outline-none"
                                               data-cart-key="{{ cart_item_key }}">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                </svg>
                                            </a>
                                        </div>

                                        <!-- Product Info -->
                                        <div class="md:col-span-5 flex items-start space-x-4">
                                            <!-- Product Image -->
                                            <div class="flex-shrink-0 w-20 h-20 bg-gray-100 rounded">
                                                {% set product_image = function('wp_get_attachment_image_url', function('get_post_thumbnail_id', image_id), 'thumbnail') %}
                                                {% if product_image %}
                                                    <img src="{{ product_image }}" 
                                                         alt="{{ product.get_name() }}" 
                                                         class="w-full h-full object-cover rounded">
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Product Details -->
                                            <div class="flex-1 min-w-0">
                                                <div class="text-sm text-gray-500 uppercase tracking-wide mb-0">
                                                    {% set brands = function('get_the_terms', brand_id, 'product_brand') %}
                                                    {% if brands and brands is not same as(false) %}
                                                        {{ brands[0].name }}
                                                    {% else %}
                                                        BRAND NAME
                                                    {% endif %}
                                                </div>
                                                <h3 class="text-base font-medium text-gray-900 mb-0">
                                                    {% if product.is_type('variation') %}
                                                        {% set parent_product = function('wc_get_product', product.get_parent_id()) %}
                                                        {{ parent_product.get_name() }}
                                                    {% else %}
                                                        {{ product.get_name() }}
                                                    {% endif %}
                                                </h3>
                                                <div class="text-sm text-gray-600">
                                                    {% if cart_item.variation %}
                                                        {% for attribute, value in cart_item.variation %}
                                                            {% set attr_name = attribute|replace({'attribute_': ''}) %}
                                                            {{ attr_name|title }}: {{ value }}<br>
                                                        {% endfor %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Quantity -->
                                        <div class="md:col-span-2 flex items-center justify-center md:justify-center">
                                            <input type="number" 
                                                   class="cart-qty-input w-16 text-center border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                   value="{{ cart_item.quantity }}" 
                                                   min="0"
                                                   name="cart[{{ cart_item_key }}][qty]"
                                                   step="1"
                                                   autocomplete="off">
                                        </div>

                                        <!-- Subtotal -->
                                        <div class="md:col-span-4 flex items-center justify-end">
                                            {% if product.is_on_sale() %}
                                                {% set regular_price = product.get_regular_price() %}
                                                {% set sale_price = product.get_sale_price() %}
                                                {% if regular_price > 0 %}
                                                    {% set sale_percentage = ((regular_price - sale_price) / regular_price * 100)|round %}
                                                    <div class="flex items-center space-x-2">
                                                        <!-- Sale percentage badge -->
                                                        <span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded">
                                                            -{{ sale_percentage }}%
                                                        </span>
                                                        <!-- Regular price (crossed out) -->
                                                        <span class="text-sm text-gray-500 line-through">
                                                            {{ function('wc_price', regular_price * cart_item.quantity)|raw }}
                                                        </span>
                                                        <!-- Sale price (actual total) -->
                                                        <span class="text-lg font-medium text-gray-900">
                                                            {{ function('wc_price', sale_price * cart_item.quantity)|raw }}
                                                        </span>
                                                    </div>
                                                {% endif %}
                                            {% else %}
                                                <!-- Regular price for non-sale items -->
                                                <span class="text-lg font-medium text-gray-900">
                                                    {{ function('wc_price', cart_item.line_total)|raw }}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                                
                                {{ function('do_action', 'woocommerce_after_cart_contents')|raw }}
                                {{ function('do_action', 'woocommerce_after_cart_table')|raw }}
                                
                                <!-- Cart Actions -->
                                <div class="flex flex-col sm:flex-row sm:justify-end items-center mt-8 pt-6 border-t border-gray-200 gap-4">
                                    <a href="{{ function('wc_get_page_permalink', 'shop') }}" 
                                       class="inline-flex items-center border border-gray-300 hover:border-gray-400 text-gray-700 px-6 py-3 rounded font-medium transition-colors">
                                        Continue Shopping
                                    </a>
                                    <button type="submit" 
                                            class="update-cart-btn inline-flex items-center bg-[#f5f5f5] hover:bg-[#FFF200] text-black px-6 py-3 rounded font-medium transition-colors"
                                            name="update_cart"
                                            value="Update cart">
                                        Update Cart
                                    </button>
                                </div>
                                {{ function('do_action', 'woocommerce_cart_actions')|raw }}
                                
                                <!-- WooCommerce Security Nonce (if not provided by cart_actions) -->
                                {{ function('wp_nonce_field', 'woocommerce-cart', 'woocommerce-cart-nonce')|raw }}
                                
                                </form>
                                </div>
                                <!-- WooCommerce after cart hook -->
                                {{ function('do_action', 'woocommerce_after_cart')|raw }}
                                
                            {% else %}
                                <!-- Empty Cart -->
                                <div class="text-center py-12">
                                    <p class="text-gray-600 text-lg mb-6">Your cart is empty</p>
                                    <a href="{{ function('wc_get_page_permalink', 'shop') }}" 
                                       class="inline-flex items-center bg-yellow-400 hover:bg-yellow-500 text-black px-6 py-3 rounded font-medium transition-colors">
                                        Continue Shopping
                                    </a>
                                </div>
                            {% endif %}

                            <!-- Do you also need? Section -->
                            <div class="mt-20">
                                <div class="mb-8">
                                    <h2 class="text-3xl font-medium text-gray-900">Do you also need?</h2>
                                </div>

                                <!-- Related Products Grid -->
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                                    {% set related_products = function('wc_get_products', {
                                        'limit': 3,
                                        'orderby': 'rand',
                                        'status': 'publish'
                                    }) %}
                                    
                                    {% for product in related_products %}
                                        {% set product_post = function('get_post', product.get_id()) %}
                                        {% if product_post %}
                                            {% include 'woocommerce/product-card.twig' with {
                                                'post': product_post,
                                                'show_brand': true,
                                                'show_sale_badge': true
                                            } %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    

                    <!-- Cart Totals - 40% (5/12 cols) -->
                    <div class="lg:col-span-5">
                        <div class="cart-totals bg-gray-50 rounded-lg p-6 {{ function('WC').customer.has_calculated_shipping() ? 'calculated_shipping' : '' }}">
                            {{ function('do_action', 'woocommerce_before_cart_totals')|raw }}
                            
                            <h3 class="text-xl font-semibold text-gray-900 mb-6">Cart Totals</h3>
                            
                            <!-- Cart Totals Table -->
                            <div class="space-y-3 mb-6">
                                <!-- Subtotal -->
                                <div class="flex justify-between items-center py-3 border-b border-gray-200 cart-subtotal">
                                    <span class="text-gray-600">Subtotal</span>
                                    <span class="font-medium text-gray-900">
                                        {{ function('wc_cart_totals_subtotal_html')|raw }}
                                    </span>
                                </div>

                                <!-- Coupons -->
                                {% set coupons = wc_cart.get_coupons() %}
                                {% if coupons %}
                                    {% for code, coupon in coupons %}
                                        <div class="flex justify-between items-center py-3 border-b border-gray-200 cart-discount coupon-{{ function('sanitize_title', code) }}">
                                            <span class="text-gray-600">{{ function('wc_cart_totals_coupon_label', coupon, false) }}</span>
                                            <span class="font-medium text-gray-900">
                                                {{ function('wc_cart_totals_coupon_html', coupon)|raw }}
                                            </span>
                                        </div>
                                    {% endfor %}
                                {% endif %}

                                <!-- Shipping -->
                                {% if wc_cart.needs_shipping() and wc_cart.show_shipping() %}
                                    {{ function('do_action', 'woocommerce_cart_totals_before_shipping')|raw }}
                                    
                                    <div class="py-3 border-b border-gray-200 shipping">
                                        {{ function('wc_cart_totals_shipping_html')|raw }}
                                    </div>
                                    
                                    {{ function('do_action', 'woocommerce_cart_totals_after_shipping')|raw }}
                                {% elseif wc_cart.needs_shipping() and function('get_option', 'woocommerce_enable_shipping_calc') == 'yes' %}
                                    <div class="flex justify-between items-center py-3 border-b border-gray-200 shipping">
                                        <span class="text-gray-600">Shipping</span>
                                        <div class="text-right">
                                            {{ function('woocommerce_shipping_calculator')|raw }}
                                        </div>
                                    </div>
                                {% endif %}

                                <!-- Fees -->
                                {% set fees = wc_cart.get_fees() %}
                                {% if fees %}
                                    {% for fee in fees %}
                                        <div class="flex justify-between items-center py-3 border-b border-gray-200 fee">
                                            <span class="text-gray-600">{{ fee.name }}</span>
                                            <span class="font-medium text-gray-900">
                                                {{ function('wc_cart_totals_fee_html', fee)|raw }}
                                            </span>
                                        </div>
                                    {% endfor %}
                                {% endif %}

                                <!-- Tax -->
                                {% if function('wc_tax_enabled') and not wc_cart.display_prices_including_tax() %}
                                    {% set taxable_address = function('WC').customer.get_taxable_address() %}
                                    {% set estimated_text = '' %}
                                    
                                    {% if function('WC').customer.is_customer_outside_base() and not function('WC').customer.has_calculated_shipping() %}
                                        {% set estimated_text = ' <small>(estimated for ' ~ function('WC').countries.estimated_for_prefix(taxable_address[0]) ~ function('WC').countries.countries[taxable_address[0]] ~ ')</small>' %}
                                    {% endif %}
                                    
                                    {% if function('get_option', 'woocommerce_tax_total_display') == 'itemized' %}
                                        {% set tax_totals = wc_cart.get_tax_totals() %}
                                        {% for code, tax in tax_totals %}
                                            <div class="flex justify-between items-center py-3 border-b border-gray-200 tax-rate tax-rate-{{ function('sanitize_title', code) }}">
                                                <span class="text-gray-600">{{ tax.label|raw }}{{ estimated_text|raw }}</span>
                                                <span class="font-medium text-gray-900">{{ tax.formatted_amount|raw }}</span>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="flex justify-between items-center py-3 border-b border-gray-200 tax-total">
                                            <span class="text-gray-600">{{ function('WC').countries.tax_or_vat()|raw }}{{ estimated_text|raw }}</span>
                                            <span class="font-medium text-gray-900">
                                                {{ function('wc_cart_totals_taxes_total_html')|raw }}
                                            </span>
                                        </div>
                                    {% endif %}
                                {% endif %}

                                {{ function('do_action', 'woocommerce_cart_totals_before_order_total')|raw }}

                                <!-- Total -->
                                <div class="flex justify-between items-center py-4 text-lg font-semibold order-total">
                                    <span>Total</span>
                                    <span>{{ function('wc_cart_totals_order_total_html')|raw }}</span>
                                </div>

                                {{ function('do_action', 'woocommerce_cart_totals_after_order_total')|raw }}
                            </div>

                            <!-- Proceed to Checkout -->
                            <a href="{{ function('wc_get_checkout_url') }}" 
                               class="w-full inline-block text-center bg-[#FFF200] text-black py-3 px-6 rounded-lg font-semibold transition-colors mt-4">
                                Proceed to Checkout
                            </a>

                            {{ function('do_action', 'woocommerce_after_cart_totals')|raw }}
                        </div>
                    </div>
                </div>
                </div>
            {% else %}
                <div class="text-center py-12">
                    <p class="text-gray-600 text-lg">WooCommerce is not available.</p>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}